// schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BlockCategory {
    BUILDING
    ROAD
    WATER
}

enum TrafficLevel {
    UNKNOWN
    SMOOTH
    NORMAL
    CONGESTED
}

enum RoadEvent {
    ACCIDENT
    CONSTRUCTION
    ROAD_CLOSURE
}

model MapNode {
  id      String   @id @default(uuid())
  x       Int
  y       Int
  block   BlockCategory
  traffic TrafficLevel @default(UNKNOWN)
  event   RoadEvent?
  roadId  String?
  road    ObjectList?   @relation(fields: [roadId], references: [id])


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // 复合唯一索引，确保每个坐标点唯一
  @@unique([x, y])
  // 为查询优化添加索引
  @@index([x, y])
}

model ObjectList {
  id        String   @id @default(uuid())
  name      String
  type      BlockCategory
  nodes     MapNode[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

}

// 道路定义
model Road {
  id          String   @id @default(uuid())
  name        String   @unique  // 道路1, 道路2
  description String?

  centerLines CenterLine[]
  keyPoints   KeyPoint[]
  lanes       Lane[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 中心线定义
model CenterLine {
  id          String   @id @default(uuid())
  roadId      String
  road        Road     @relation(fields: [roadId], references:  [id], onDelete: Cascade)

  type        String   // "HORIZONTAL" | "VERTICAL"

  // 水平线:  y固定, x范围
  // 垂直线: x固定, y范围
  fixedAxis   String   // "X" | "Y"
  fixedValue  Int      // 固定的坐标值
  startValue  Int      // 起始值
  endValue    Int      // 结束值

  @@index([roadId])
}

// 关键点（路口、转角、端点）
model KeyPoint {
  id          String   @id @default(uuid())
  roadId      String
  road        Road     @relation(fields: [roadId], references: [id], onDelete: Cascade)

  name        String   // "左起点", "路口", "右T路口", "上拐角" 等
  x           Int
  y           Int
  type        String   // "ENDPOINT" | "INTERSECTION" | "T_JUNCTION" | "CORNER" | "ENTRANCE"

  // 连接的其他关键点
  connectedTo String[] // KeyPoint IDs

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([roadId, x, y])
  @@index([roadId])
}

// 车道定义（基于道路段）
model Lane {
  id           String   @id @default(uuid())
  roadId       String
  road         Road     @relation(fields: [roadId], references:  [id], onDelete: Cascade)

  laneNumber   Int      // 车道编号
  direction    String   // "FORWARD" | "BACKWARD"

  // 车道的起止点
  startX       Int
  startY       Int
  endX         Int
  endY         Int

  // 车道属性
  width        Int      @default(8)
  centerOffset Int      // 相对中心线的偏移 (+4 或 -4)
  isOpen       Boolean  @default(true)
  speedLimit   Int      @default(60)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([roadId])
}

model Vehicle {
  id          String   @id @default(uuid())
  type        String   // "CAR" | "TRUCK" | "MOTORCYCLE" | etc.
  currentX    Int
  currentY    Int
  speed       Int
  direction   String   // "NORTH" | "SOUTH" | "EAST" | "WEST"
  distance    Int
  angle       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([currentX, currentY])
}

model VehicleLocationHistory {
  id          String   @id @default(uuid())
  vehicleId   String
  X           Int
  Y           Int
  type        String
  direction   String   // "NORTH" | "SOUTH" | "EAST" | "WEST"
  distance    Int
  angle       Int
  valid       Boolean  @default(false)
  events      Int
  rssi        Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([X, Y])
}

// 红绿灯模型
model TrafficLight {
  id          String   @id @default(cuid())
  name        String
  x           Float    // 地图坐标
  y           Float
  roadId      String?   // 关联道路
  state       TrafficLightState @default(RED)
  lastChanged DateTime @default(now())
  duration    Int      @default(30) // 当前状态持续时间(秒)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([roadId])
}

// 停车场大门模型
model ParkingGate {
  id          String   @id @default(cuid())
  name        String
  x           Float
  y           Float
  state       GateState @default(CLOSED)
  parkingLotId String? 
  lastOpened  DateTime?
  lastClosed  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([parkingLotId])
}

enum TrafficLightState {
  RED
  YELLOW
  GREEN
}

enum GateState {
  OPEN
  CLOSED
  OPENING
  CLOSING
  ERROR
}

enum GateAction {
  OPEN
  CLOSE
  AUTO_OPEN
  AUTO_CLOSE
}