# 定义流水线的阶段
stages:
  - build
  - deploy

# 定义一个构建和推送 Docker 镜像到 Harbor 的作业 (使用 Kaniko)
build_and_push_docker_image_to_harbor_kaniko:
  stage: build

  image: registry.dforwa.cn:2053/library/kaniko-executor:debug

  variables:
    HARBOR_FULL_ADDRESS: "$HARBOR_HOST:2053"
    PROJECT_NAME: $CI_PROJECT_NAME
    DOCKER_IMAGE_BASE: "$HARBOR_FULL_ADDRESS/$HARBOR_PROJECT/$PROJECT_NAME"
    DOCKER_IMAGE_TAG_SHA: "$DOCKER_IMAGE_BASE:$CI_COMMIT_SHORT_SHA"
    DOCKER_IMAGE_TAG_LATEST: "$DOCKER_IMAGE_BASE:latest"

  before_script:
    - |
      echo "Generating Harbor authentication file..."
      mkdir -p /kaniko/.docker
      echo "{\"auths\":{\"$HARBOR_FULL_ADDRESS\":{\"username\":\"$HARBOR_USERNAME\",\"password\":\"$HARBOR_PASSWORD\"}}}" > /kaniko/.docker/config.json
      echo "Harbor authentication file created at /kaniko/.docker/config.json"

  script:
    # 构建带有 SHA 标签的镜像并推送
    - |
      echo "Building and pushing Docker image: $DOCKER_IMAGE_TAG_SHA using Kaniko"
      /kaniko/executor \
        --context . \
        --dockerfile Dockerfile \
        --destination $DOCKER_IMAGE_TAG_SHA \
        --cache=true \
        --cache-repo $DOCKER_IMAGE_BASE/cache \
        --snapshotMode=redo \
        --use-new-run

    # 如果是主分支，推送 latest 标签
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ "$CI_COMMIT_BRANCH" = "master" ]; then
        LATEST_TAG="$DOCKER_IMAGE_BASE:latest"
        echo "Building and pushing latest image: $LATEST_TAG using Kaniko"
        /kaniko/executor \
          --context . \
          --dockerfile Dockerfile \
          --destination $LATEST_TAG \
          --cache=true \
          --cache-repo $DOCKER_IMAGE_BASE/cache \
          --snapshotMode=redo \
          --use-new-run
      fi

    # 如果是非主分支，推送带有分支名的标签
    - |
      if [ "$CI_COMMIT_BRANCH" != "main" ] && [ "$CI_COMMIT_BRANCH" != "master" ]; then
        # 将分支名中的特殊字符替换为连字符，使其符合 Docker tag 规范
        SAFE_BRANCH_NAME=$(echo "$CI_COMMIT_BRANCH" | sed 's/[^a-zA-Z0-9._-]/-/g')
        BRANCH_TAG="$DOCKER_IMAGE_BASE:$SAFE_BRANCH_NAME"
        echo "Building and pushing branch image: $BRANCH_TAG using Kaniko"
        /kaniko/executor \
          --context . \
          --dockerfile Dockerfile \
          --destination $BRANCH_TAG \
          --cache=true \
          --cache-repo $DOCKER_IMAGE_BASE/cache \
          --snapshotMode=redo \
          --use-new-run
      fi

  rules:
    - if: $CI_COMMIT_BRANCH